# ADR-0002: Ticker Library Report Storage with Latest Pointers

## Status
**ACCEPTED** - 2025-09-06

## Context

We need to decide how to store and organize research reports for the AI Stock Market Research Workbench. The choice affects daily workflow, data discovery, and system usability.

### User Workflow Analysis
Primary use case is individual ticker research with these access patterns:
1. **Primary**: "Show me latest analysis for AAPL" (most common)
2. **Secondary**: "What did I analyze today?" (daily workflow)
3. **Tertiary**: "Show AAPL analysis over time" (historical review)

## Decision Drivers

1. **User Mental Model**: Users think in terms of "AAPL stuff", not dates
2. **Scalability**: System should handle 100+ tickers cleanly
3. **Latest Access**: Fast access to most recent analysis per ticker
4. **Cross-Ticker Discovery**: Ability to see today's work across all tickers
5. **Windows Compatibility**: Symlinks may not be available
6. **Atomic Operations**: Prevent partial writes and broken pointers

## Considered Options

### Option A: Flat Structure with Symlinks
```
reports/
├── AAPL_2025-09-06_1430_report.md
├── AAPL_latest.md → AAPL_2025-09-07_1500_report.md
└── MSFT_2025-09-06_1445_report.md
```

**Pros**: Simple, chronological sorting
**Cons**: Directory pollution, harder cleanup, no natural grouping

### Option B: Ticker Libraries with Latest Pointers ✅
```
reports/
├── AAPL/
│   ├── latest.md → 2025-09-07_150000_report.md
│   ├── 2025-09-06_143000_report.md
│   └── 2025-09-07_150000_report.md
├── MSFT/
│   ├── latest.md → 2025-09-06_144500_report.md
│   └── 2025-09-06_144500_report.md
└── latest_reports.json
```

**Pros**: Matches mental model, scales cleanly, easy cleanup, clear latest mechanism
**Cons**: Slightly more complex, requires cross-ticker index

### Option C: Date-First with Ticker Index
```
reports/
├── 2025-09-06/AAPL_report.md
├── 2025-09-07/AAPL_report.md
└── by_ticker/AAPL_latest.md → ../2025-09-07/AAPL_report.md
```

**Pros**: Great for date-based queries
**Cons**: Complex navigation, doesn't match ticker-focused workflow

## Decision

**We choose Option B: Ticker Libraries with Latest Pointers**

### Implementation Details

#### Directory Structure
```
reports/
├── {TICKER}/
│   ├── {YYYY-MM-DD_HHMMSS}_report.md
│   ├── {YYYY-MM-DD_HHMMSS}_metrics.json  # Optional sidecar
│   └── latest.md                          # Symlink or copy
├── latest_reports.json                    # Cross-ticker index
└── .gitignore                            # Exclude from git
```

#### Filename Convention
- **Format**: `{YYYY-MM-DD_HHMMSS}_report.md`
- **Timezone**: Local timezone (America/Phoenix) for filenames
- **Sorting**: Lexicographic sorting = chronological sorting
- **Example**: `2025-09-07_150000_report.md`

#### Latest Pointer Strategy
1. **Prefer symlinks**: `latest.md → 2025-09-07_150000_report.md`
2. **Windows fallback**: Copy file to `latest.md` if symlinks unavailable
3. **Strategy tracking**: Record method in cross-ticker index

#### Atomic Operations
1. **Report writing**: Write to temp file → fsync → atomic rename
2. **Pointer updates**: Atomic symlink/copy replacement
3. **Index updates**: Write temp JSON → atomic rename
4. **Concurrency**: Per-ticker file locks for pointer updates

#### Cross-Ticker Index Schema
```json
{
  "generated_at_utc": "2025-09-07T22:00:00Z",
  "timezone": "America/Phoenix", 
  "latest": [
    {
      "ticker": "AAPL",
      "report_path": "reports/AAPL/2025-09-07_150000_report.md",
      "latest_path": "reports/AAPL/latest.md",
      "run_id": 1234,
      "generated_at_local": "2025-09-07T15:00:00-07:00",
      "pointer_strategy": "symlink"
    }
  ]
}
```

## Consequences

### Positive
- **Intuitive navigation**: Matches user mental model
- **Scalable**: Clean organization for 100+ tickers
- **Fast latest access**: Direct path to most recent analysis
- **Cross-ticker discovery**: JSON index enables "today" queries
- **Windows compatible**: Fallback strategy for symlink limitations
- **Atomic safety**: No partial writes or broken pointers

### Negative
- **Complexity**: More implementation than flat structure
- **Index maintenance**: Must keep cross-ticker index synchronized
- **Symlink dependency**: Requires fallback logic for Windows

### Neutral
- **Directory count**: One per ticker (manageable)
- **File organization**: Trades simplicity for structure

## CLI User Experience

```bash
# Primary workflow
python cli.py report AAPL                    # Generate latest report
python cli.py report latest AAPL             # View latest report

# Discovery workflows  
python cli.py report today                   # Today's reports across all tickers
python cli.py report history AAPL            # All AAPL reports over time

# Maintenance
python cli.py report rebuild-index           # Regenerate index
python cli.py report prune --retain 10       # Cleanup old reports
```

## Environment Configuration

Only add to `.env.example` if actually used:
```bash
REPORT_DIR=./reports
REPORTS_TZ=America/Phoenix
REPORTS_USE_SYMLINKS=true
REPORTS_RETENTION_N=10
REPORTS_INDEX_PATH=./reports/latest_reports.json
```

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Symlink failures on Windows | Copy fallback with strategy tracking |
| Concurrent writes | Per-ticker file locks |
| Broken latest pointers | Validation and auto-repair |
| Index corruption | Rebuild command and validation |

## Validation

Success criteria:
1. **Intuitive access**: `reports/AAPL/latest.md` always works
2. **Fast discovery**: Cross-ticker index queries < 100ms
3. **Atomic safety**: No partial files under any failure scenario
4. **Windows compatibility**: Works with or without symlink support

## References

- User workflow analysis from Phase 4 planning
- File system atomicity best practices
- Windows symlink limitations research

---

**Decided by**: User + AI Architecture Review  
**Date**: 2025-09-06  
**Review Date**: After Phase 4 completion
