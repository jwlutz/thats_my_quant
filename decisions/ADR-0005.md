# ADR-0005: Sentiment Analysis Architecture - Multi-Source Local-First Approach

## Status
**ACCEPTED** - 2025-01-XX

## Context

With the bulletproof LangChain integration complete (Phase L), we need to add sentiment analysis capabilities to enhance research reports with market sentiment insights. The challenge is building a quantitative, auditable sentiment layer while maintaining our local-first, no-hallucination principles.

## Decision Drivers

1. **Quantitative Focus**: Sentiment must be measurable and auditable, not subjective
2. **Local-First**: Minimize external dependencies, keep data and models local
3. **Multi-Source**: Blend institutional, news, and public sentiment for comprehensive view
4. **Relevance**: Focus on price-moving catalysts, not general noise
5. **Deterministic**: Same inputs must produce same outputs
6. **Optional Features**: Public sentiment behind flags (Reddit/X require credentials)

## Considered Options

### Option A: News-Only Sentiment
Use only RSS news feeds with local FinBERT classification.
**Pros**: Simple, reliable, no external APIs
**Cons**: Misses institutional behavior and public sentiment signals
**Assessment**: Too narrow for comprehensive analysis

### Option B: External Sentiment APIs
Use services like NewsAPI, Alpha Vantage sentiment, or social sentiment APIs.
**Pros**: Rich data, pre-processed sentiment scores
**Cons**: External dependencies, costs, rate limits, potential hallucinations
**Assessment**: Violates local-first principle

### Option C: Multi-Source Local-First Approach ✅
Blend institutional sentiment (13F deltas), news sentiment (RSS + local FinBERT), and optional public sentiment.
**Pros**: Comprehensive, local control, auditable, scalable
**Cons**: More complex implementation, requires multiple data sources
**Assessment**: Best balance of comprehensiveness and control

## Decision

**We choose Option C: Multi-Source Local-First Sentiment Analysis**

### Architecture Overview

```
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│   Institutional     │    │      News           │    │     Public          │
│   Sentiment         │    │   Sentiment         │    │   Sentiment         │
│   (13F Deltas)      │    │  (RSS + FinBERT)    │    │ (Reddit/X Optional) │
└─────────────────────┘    └─────────────────────┘    └─────────────────────┘
           │                           │                           │
           │                           │                           │
           ▼                           ▼                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Sentiment Aggregation Engine                            │
│            (Relevance • Change • Catalysts • Z-scores)                     │
└─────────────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Enhanced MetricsJSON v2                                 │
│                 (sentiment section + audit_index)                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Data Sources Strategy

#### 1. Institutional Sentiment (Always Enabled)
**Source**: 13F filing deltas between quarters + SEC Form 4 insider trading
**Metrics**: 
- Stake value changes (absolute $ and %)
- Concentration changes (CR5, HHI deltas)
- New top holder entries/exits
- Institution count changes
- Insider trading volume and direction (Form 4 filings)
- Executive transaction patterns and timing

**Rationale**: Institutional and insider money movements are the strongest sentiment signals

#### 2. News Sentiment (RSS-First)
**Primary**: RSS feeds from high-quality financial news sources
**Classifier**: Local FinBERT model for financial sentiment
**Optional**: OpenBB news provider (if credentialed)

**RSS Sources** (curated for quality):
- Reuters Business
- MarketWatch  
- Yahoo Finance
- Seeking Alpha
- Bloomberg RSS (if available)

**Rationale**: RSS is reliable, cacheable, and doesn't require API keys

#### 3. Search Interest Sentiment (Google Trends)
**Source**: pytrends library for Google Trends data
**Metrics**:
- Search volume trends for ticker symbols
- Related queries and rising searches
- Geographic interest distribution
- Comparative search interest vs market benchmarks

**Rationale**: Search interest often precedes price movements and indicates retail sentiment

#### 4. Search Interest Sentiment (Google Trends)
**Source**: pytrends library for Google Trends data
**Metrics**:
- Search volume trends for ticker symbols
- Related queries and rising searches
- Geographic interest distribution
- Abnormality scoring across 7/30/90-day windows

**Rationale**: Search interest often precedes price movements and indicates retail sentiment

#### 5. Public Sentiment (Core Functionality)
**Reddit**: Official PRAW API with financial subreddit focus
**X (Twitter)**: Official API v2 for $TICKER mentions and financial discussions
**Default**: ENABLED (requires credentials but core to comprehensive sentiment)

**Rationale**: Public sentiment is essential for complete market sentiment picture, not optional

### Technical Implementation

#### Data Pipeline
1. **Raw Ingestion**: Fetch from all enabled sources with conditional gets (ETag/Last-Modified)
2. **Normalization**: Canonical schemas with ticker mapping and deduplication
3. **Classification**: Local FinBERT for sentiment scoring (pos/neu/neg + confidence)
4. **Aggregation**: Time-weighted sentiment scores with relevance filtering
5. **Integration**: Add sentiment section to Enhanced MetricsJSON v2

#### Enhanced Abnormality-Based Sentiment Scoring Algorithm
```python
def calculate_abnormality_sentiment_score(ticker: str, as_of_date: date) -> dict:
    """
    Calculate comprehensive sentiment score based on abnormality detection across multiple timeframes.
    
    Multi-Timeframe Abnormality Analysis:
    - 7-day: Immediate sentiment shifts (weight: 50%)
    - 30-day: Trend development (weight: 30%) 
    - 90-day: Structural changes (weight: 20%)
    
    Components (equal weight: 20% each):
    1. Institutional abnormality: 13F delta Z-scores + percentiles
    2. Insider abnormality: Form 4 transaction volume/direction vs baseline
    3. News abnormality: Article volume + sentiment intensity vs baseline
    4. Search abnormality: Google Trends volume spikes vs baseline
    5. Public abnormality: Reddit/X mention volume + sentiment vs baseline
    
    Returns:
    {
        'composite_abnormality_score': float (-3.0 to +3.0),  # Z-score based
        'composite_percentile': float (0.0 to 1.0),          # Percentile ranking
        'composite_classification': str,                      # 'normal', 'unusual', 'extreme'
        'confidence': float (0.0 to 1.0),
        
        'timeframes': {
            '7d': {'score': float, 'weight': 0.50, 'classification': str},
            '30d': {'score': float, 'weight': 0.30, 'classification': str},
            '90d': {'score': float, 'weight': 0.20, 'classification': str}
        },
        
        'components': {
            'institutional': {
                'abnormality_score': float (-3.0 to +3.0),
                'percentile': float (0.0 to 1.0),
                'classification': str,
                'baseline_mean': float,
                'baseline_std': float,
                'current_value': float,
                'data_points': int,
                'confidence': float
            },
            'insider': { /* same structure */ },
            'news': { /* same structure */ },
            'search': { /* same structure */ },
            'public': { /* same structure */ }
        },
        
        'context_adjustments': {
            'earnings_week': bool,
            'dividend_ex_date': bool,
            'earnings_call': bool,
            'sector_event': bool,
            'adjustment_factor': float  # Applied to abnormality thresholds
        },
        
        'catalysts': [
            {
                'type': str,  # 'search_spike', 'insider_cluster', 'news_volume', etc.
                'description': str,
                'abnormality_score': float,
                'timeframe': str,  # '7d', '30d', '90d'
                'source': str,
                'confidence': float
            }
        ],
        
        'data_quality': {
            'baseline_sufficiency': {'7d': bool, '30d': bool, '90d': bool},
            'missing_sources': list[str],
            'oldest_data_age_hours': float,
            'total_data_points': int
        }
    }
    """
```

#### Relevance Filtering
**News Items Must Have**:
- Ticker mentioned in title OR first paragraph
- Financial keywords (earnings, revenue, guidance, acquisition, etc.)
- Recent publication (within sentiment window)
- Minimum confidence threshold (0.7 for FinBERT)

**Public Posts Must Have**:
- Explicit ticker mention ($AAPL, AAPL, Apple)
- Minimum engagement (upvotes/likes above threshold)
- Not bot/spam (basic heuristics)

### Schema Design

#### Core Tables
```sql
-- Raw news from all sources
CREATE TABLE news_raw (
    url_hash TEXT PRIMARY KEY,
    canonical_url TEXT NOT NULL,
    title TEXT NOT NULL,
    body TEXT,
    published_at DATETIME NOT NULL,
    source TEXT NOT NULL,
    author TEXT,
    fetched_at DATETIME NOT NULL,
    ticker_hint TEXT
);

-- Cleaned and normalized news
CREATE TABLE news_clean (
    id TEXT PRIMARY KEY,
    url_hash TEXT NOT NULL,
    ticker TEXT NOT NULL,
    published_at DATETIME NOT NULL,
    source TEXT NOT NULL,
    source_type TEXT NOT NULL, -- rss|openbb|api
    title TEXT NOT NULL,
    body TEXT,
    dedupe_group TEXT,
    as_of DATE NOT NULL,
    ingested_at DATETIME NOT NULL,
    FOREIGN KEY(url_hash) REFERENCES news_raw(url_hash)
);

-- Sentiment scores for news
CREATE TABLE news_sentiment (
    id TEXT PRIMARY KEY,
    news_id TEXT NOT NULL,
    model TEXT NOT NULL,
    model_version TEXT NOT NULL,
    label TEXT NOT NULL CHECK(label IN('pos','neu','neg')),
    score_pos REAL NOT NULL,
    score_neu REAL NOT NULL,
    score_neg REAL NOT NULL,
    confidence REAL NOT NULL,
    computed_at DATETIME NOT NULL,
    FOREIGN KEY(news_id) REFERENCES news_clean(id)
);

-- Institutional sentiment snapshots
CREATE TABLE inst_sentiment (
    ticker TEXT NOT NULL,
    as_of DATE NOT NULL,
    cr5 REAL,
    cr5_delta REAL,
    hhi REAL,
    hhi_delta REAL,
    total_value_usd REAL,
    value_delta_usd REAL,
    value_delta_pct REAL,
    holder_count INTEGER,
    holder_count_delta INTEGER,
    new_top_holders INTEGER,
    exited_top_holders INTEGER,
    sentiment_score REAL, -- Derived from deltas
    computed_at DATETIME NOT NULL,
    PRIMARY KEY(ticker, as_of)
);

-- Aggregated sentiment snapshots
CREATE TABLE sentiment_snapshot (
    ticker TEXT NOT NULL,
    as_of DATE NOT NULL,
    window_days INTEGER NOT NULL,
    
    -- News sentiment
    news_count INTEGER NOT NULL DEFAULT 0,
    news_avg_score REAL,
    news_pos_pct REAL,
    news_neu_pct REAL,
    news_neg_pct REAL,
    news_confidence REAL,
    
    -- Public sentiment (optional)
    public_count INTEGER NOT NULL DEFAULT 0,
    public_avg_score REAL,
    public_pos_pct REAL,
    public_neu_pct REAL,
    public_neg_pct REAL,
    
    -- Institutional sentiment
    inst_score REAL,
    inst_confidence REAL,
    
    -- Composite
    composite_score REAL NOT NULL,
    composite_confidence REAL NOT NULL,
    
    -- Metadata
    catalysts JSON,
    data_quality JSON,
    computed_at DATETIME NOT NULL,
    
    PRIMARY KEY(ticker, as_of, window_days)
);
```

### Implementation Phases

#### Phase SNT1-4: Core Infrastructure
1. **SNT0**: This ADR + schema design
2. **SNT1**: RSS ingestion with conditional gets and deduplication
3. **SNT2**: Optional external providers (OpenBB) with rate limiting
4. **SNT3**: News normalization, ticker mapping, and SQLite storage
5. **SNT4**: Local FinBERT sentiment classification with batch processing

#### Phase SNT5-8: Integration & Polish
6. **SNT5**: Institutional sentiment calculation from 13F deltas
7. **SNT6**: Sentiment aggregation engine with relevance filtering
8. **SNT7**: Integration with Enhanced MetricsJSON v2 and report generation
9. **SNT8**: CLI commands and performance optimization

### Risk Mitigation

#### Technical Risks
- **RSS Feed Reliability**: Use multiple sources, graceful degradation
- **FinBERT Model Size**: Provide fallback to simple keyword-based scoring
- **Rate Limiting**: Implement aggressive caching and request throttling
- **Data Volume**: Limit news items per ticker/day, implement TTL cleanup

#### Data Quality Risks
- **Irrelevant News**: Strict relevance filtering with ticker mention + financial keywords
- **Duplicate Detection**: Use rapidfuzz for near-duplicate title detection
- **Spam/Bot Content**: Basic heuristics for public sentiment sources
- **Stale Data**: TTL-based cleanup and freshness indicators

#### Compliance Risks
- **RSS ToS**: Honor robots.txt, rate limits, and conditional gets
- **API Terms**: Use only official APIs, never scrape social platforms
- **Data Privacy**: No PII storage, anonymize public content

### Performance Targets

- **News Processing**: <5 seconds for 50 news items per ticker
- **Sentiment Classification**: <10 seconds for batch processing
- **Database Queries**: <100ms for sentiment snapshot retrieval
- **Storage Growth**: <10MB per ticker per month

### Success Criteria

#### Functional Requirements
- ✅ Deterministic sentiment scores (same inputs → same outputs)
- ✅ Graceful degradation when sources unavailable
- ✅ Integration with existing report generation
- ✅ CLI commands for sentiment analysis
- ✅ Comprehensive audit trail

#### Quality Requirements
- ✅ >95% uptime for RSS ingestion
- ✅ <5% false positive rate for relevance filtering
- ✅ Sentiment scores correlate with known market events
- ✅ Zero hallucinated sentiment data in reports

## Implementation Plan

### Immediate Next Steps (SNT0-SNT2)
1. **Create sentiment package** with proper structure
2. **Implement RSS ingestion** with conditional gets and deduplication
3. **Add optional OpenBB integration** with rate limiting
4. **Update SCHEMAS.md** with sentiment table definitions

### Dependencies to Add
```
# RSS parsing
feedparser>=6.0.0,<7.0.0

# Sentiment classification (local)
transformers>=4.30.0,<5.0.0
torch>=2.0.0,<3.0.0  # For FinBERT

# Text processing
rapidfuzz>=3.0.0,<4.0.0  # Near-duplicate detection

# Optional external providers
openbb>=4.0.0,<5.0.0  # Only if OPENBB_ENABLED=true

# Optional social APIs (only if enabled)
praw>=7.0.0,<8.0.0  # Reddit (if REDDIT_ENABLED=true)
```

### Environment Configuration
Only add variables that are actually used in each phase:
- **SNT1**: RSS configuration
- **SNT4**: FinBERT model path
- **SNT2**: Optional OpenBB (if implemented)
- **Later**: Optional social APIs (if implemented)

## Consequences

### Positive
- **Comprehensive Sentiment**: Multi-source approach provides complete market sentiment picture
- **Local Control**: All processing happens locally with user-controlled data
- **Auditable**: Deterministic scoring with full audit trail
- **Scalable**: Architecture supports adding new sources without major refactoring
- **Optional Features**: Users can enable only the sources they want/credential

### Negative
- **Implementation Complexity**: More complex than single-source approach
- **Storage Requirements**: Additional SQLite tables and potential storage growth
- **Model Dependencies**: FinBERT requires transformers library and model download
- **Maintenance**: Multiple data sources require ongoing monitoring

### Risk Mitigation
- **Graceful Degradation**: System works with any subset of sources enabled
- **Fallback Strategies**: Simple keyword-based sentiment if FinBERT unavailable
- **Rate Limiting**: Aggressive caching and request throttling
- **Data Cleanup**: TTL-based cleanup and storage limits

## Validation Plan

### Testing Strategy
- **Unit Tests**: Each component tested in isolation with fixtures
- **Integration Tests**: End-to-end sentiment pipeline with mocked sources
- **Performance Tests**: Verify processing speed and storage efficiency
- **Compliance Tests**: Validate rate limiting and API usage patterns

### Acceptance Criteria
- ✅ Sentiment scores are deterministic and auditable
- ✅ System gracefully handles missing/unavailable sources
- ✅ CLI integration maintains same UX patterns as existing commands
- ✅ No hallucinated sentiment data in reports
- ✅ Performance meets targets (processing speed, storage efficiency)

## Future Considerations

This architecture provides foundation for future enhancements:

- **Sector Sentiment**: Cross-ticker sentiment analysis for sector insights
- **Event Detection**: Automated catalyst identification from sentiment spikes
- **Sentiment History**: Long-term sentiment trend analysis
- **Custom Models**: Fine-tuned sentiment models for specific sectors

However, all additions must maintain the same local-first, auditable principles.

---

**Decided by**: User + AI Architecture Review  
**Date**: 2025-01-XX  
**Implementation**: SNT0-SNT8 with TDD micro-steps  
**Dependencies**: feedparser, transformers, optional external APIs
