# ADR-0003: Enhanced MetricsJSON for Future LLM Integration

## Status
**ACCEPTED** - 2025-09-06

## Context

After building the complete analysis engine and report storage infrastructure, we've identified the optimal strategy for LLM integration. The question is how to structure data for future LLM narrative generation while maintaining our no-hallucination principle.

## Decision Drivers

1. **Data Integrity**: All numbers must be traceable and verified
2. **LLM Readability**: JSON should be self-documenting for AI consumption
3. **Future Scalability**: Support complex multi-section reports
4. **Hallucination Prevention**: Minimize LLM invention of facts
5. **Maintainability**: Single source of truth for all data

## Considered Options

### Option A: Prose Skeleton Templates
Build prose templates filled with data, LLM polishes for readability.
**Pros**: Natural language flow
**Cons**: Complex template system, harder to maintain, LLM still works with text

### Option B: Raw MetricsJSON → LLM
Send current MetricsJSON directly to LLM for narrative generation.
**Pros**: Simple, uses existing format
**Cons**: LLM must interpret raw numbers, higher hallucination risk

### Option C: Enhanced MetricsJSON → LLM ✅
Enhance MetricsJSON with context, formatting, and interpretations for LLM consumption.
**Pros**: Self-documenting, reduces hallucination, maintains single source of truth
**Cons**: Slightly more complex JSON schema

## Decision

**We choose Option C: Enhanced MetricsJSON for LLM Consumption**

### Enhanced MetricsJSON Schema

```json
{
  "ticker": "AAPL",
  "company_name": "Apple Inc.",
  "currency": "USD",
  "analysis_context": {
    "performance_period": "1 year ending September 6, 2025",
    "data_sources": ["yfinance", "sec_edgar"],
    "key_metrics_available": ["returns", "volatility", "drawdown", "institutional_ownership"],
    "data_quality_level": "high",
    "limitations": ["limited_price_history", "quarterly_13f_lag"]
  },
  "price_metrics": {
    "current_price": {
      "value": 229.87,
      "formatted": "$229.87",
      "date": "2025-09-05",
      "date_formatted": "September 5, 2025"
    },
    "returns": {
      "1D": {
        "value": -0.0034,
        "formatted": "-0.3%",
        "interpretation": "slight daily decline",
        "data_quality": "complete"
      },
      "1M": {
        "value": 0.0891,
        "formatted": "+8.9%",
        "interpretation": "strong monthly performance",
        "data_quality": "complete"
      },
      "1Y": {
        "value": null,
        "formatted": "Not available",
        "interpretation": "insufficient_data",
        "data_quality": "incomplete"
      }
    },
    "volatility": {
      "21D_annualized": {
        "value": 0.2845,
        "formatted": "28.5%",
        "window": "21-day",
        "window_formatted": "(21-day)",
        "interpretation": "moderate volatility",
        "annualized": true
      }
    },
    "drawdown": {
      "max_drawdown": {
        "value": -0.1845,
        "formatted": "-18.5%",
        "interpretation": "significant decline"
      },
      "timeline": {
        "peak_date": "2025-07-15",
        "peak_date_formatted": "July 15, 2025",
        "trough_date": "2025-08-12", 
        "trough_date_formatted": "August 12, 2025",
        "recovery_date": "2025-08-28",
        "recovery_date_formatted": "August 28, 2025",
        "recovery_status": "fully recovered"
      },
      "duration": {
        "drawdown_days": 28,
        "recovery_days": 16,
        "total_cycle_days": 44
      }
    }
  },
  "institutional_metrics": {
    "overview": {
      "total_13f_value": {
        "value": 125000000000.0,
        "formatted": "$125.0B"
      },
      "total_holders": 145,
      "quarter_end": "2024-09-30",
      "quarter_end_formatted": "September 30, 2024",
      "data_age_days": 45
    },
    "concentration": {
      "level": "low",
      "basis": "CR5",
      "basis_formatted": "based on CR5",
      "cr5": {
        "value": 0.1234,
        "formatted": "12.3%",
        "interpretation": "diversified ownership"
      },
      "hhi": {
        "value": 0.0123,
        "interpretation": "competitive market structure"
      }
    },
    "top_holders": [
      {
        "rank": 1,
        "name": "VANGUARD GROUP INC",
        "value": 5700000000.0,
        "value_formatted": "$5.7B",
        "percentage": 0.0456,
        "percentage_formatted": "4.6%"
      }
    ]
  }
}
```

### LLM Integration Strategy

**Prompt Template**:
```
You are a neutral financial analyst. Write a 120-180 word executive summary using ONLY the provided enhanced MetricsJSON. All numbers, dates, and interpretations are pre-calculated. Use the "formatted" fields for display and "interpretation" fields for context. Do not calculate new values or add external information.

Focus on synthesizing the key performance metrics, volatility characteristics, drawdown/recovery pattern, and institutional ownership concentration level.
```

**Benefits**:
- **Self-documenting**: JSON contains context and interpretations
- **Formatted values**: LLM uses pre-formatted strings (no number formatting errors)
- **Interpretations**: Reduces need for LLM to interpret raw numbers
- **Extensible**: Easy to add new fields for future features

## Implementation Path

### Phase 4 Completion
1. **Enhance MetricsJSON schema** with formatted fields and interpretations
2. **Build enhanced JSON generator** from current MetricsJSON
3. **Create LLM prompts** optimized for enhanced JSON
4. **Implement executive summary generator** with enhanced input

### Phase 5: Advanced Reports
1. **Multi-section reports** using enhanced JSON
2. **Sentiment analysis integration** as additional JSON sections
3. **Comparative analysis** across multiple tickers
4. **Portfolio-level insights** using aggregated enhanced JSON

## Consequences

### Positive
- **Reduced hallucination**: Pre-formatted data reduces LLM interpretation errors
- **Better maintainability**: Single schema enhancement benefits all LLM tasks
- **Extensible**: Easy to add sentiment, news, valuation data later
- **Debuggable**: Enhanced JSON is human-readable for troubleshooting

### Negative
- **Larger JSON files**: More verbose than raw metrics
- **Additional processing**: Need to enhance raw metrics
- **Schema complexity**: More fields to maintain

### Risk Mitigation
- **Backward compatibility**: Keep raw MetricsJSON for analysis
- **Gradual enhancement**: Add formatted fields incrementally
- **Validation**: Ensure formatted values match raw values

## Next Steps

1. **Complete current Phase 4** with enhanced JSON approach
2. **Update analysis engine** to generate enhanced format
3. **Build LLM integration** using enhanced JSON
4. **Document schema** for future development

---

**Decided by**: User + AI Architecture Review  
**Date**: 2025-09-06  
**Implementation**: Phase 4 completion with enhanced JSON strategy
